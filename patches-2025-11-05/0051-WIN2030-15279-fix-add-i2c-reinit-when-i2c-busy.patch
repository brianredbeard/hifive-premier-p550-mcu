From 946aba97d90cdd61a83f4bd3a0f937e0a233e2f3 Mon Sep 17 00:00:00 2001
From: xuxiang <xuxiang@eswincomputing.com>
Date: Thu, 23 May 2024 10:03:01 +0800
Subject: [PATCH 051/109] WIN2030-15279:fix:add i2c reinit when i2c busy

Changelogs:
1. add i2c reinit when i2c controler status

Change-Id: I2c3b8a8470bca15dcaea348610ac4d2985b82584
---
 Core/Src/hf_i2c.c | 32 +++++++++++++++++++++++++++++++-
 1 file changed, 31 insertions(+), 1 deletion(-)

diff --git a/Core/Src/hf_i2c.c b/Core/Src/hf_i2c.c
index 2ab9397..dd657d6 100644
--- a/Core/Src/hf_i2c.c
+++ b/Core/Src/hf_i2c.c
@@ -1,7 +1,20 @@
 #include "stm32f4xx_hal.h"
 #include "main.h"
 #include <stdio.h>
+void hf_i2c_reinit(I2C_HandleTypeDef *hi2c)
+{
+	if (hi2c->Instance == I2C1)
+	{
+		i2c_deinit(I2C1);
+		i2c_init(I2C1);
+	}
+	else if (hi2c->Instance == I2C3)
+	{
+		i2c_deinit(I2C3);
+		i2c_init(I2C3);
+	}
 
+}
 int hf_i2c_reg_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 					 uint8_t reg_addr, uint8_t *data_ptr)
 {
@@ -11,6 +24,7 @@ int hf_i2c_reg_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							   data_ptr, 0x1, 0xff);
 	if (status != HAL_OK) {
 		printf("I2Cx_write_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
+		hf_i2c_reinit(&hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -28,6 +42,7 @@ int hf_i2c_reg_read(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							  data_ptr, 0x1, 0xff);
 	if (status != HAL_OK){
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
+		hf_i2c_reinit(&hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -47,6 +62,7 @@ int hf_i2c_mem_read(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 	if (status != HAL_OK)
 	{
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
+		hf_i2c_reinit(&hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -72,7 +88,11 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 								I2C_MEMADD_SIZE_8BIT, data_ptr + i, 1,
 								1000);
 		if (status != HAL_OK)
+		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
+			hf_i2c_reinit(&hi2c);
+			goto out;
+		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
 		while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
 	}
@@ -84,7 +104,11 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 								I2C_MEMADD_SIZE_8BIT, data_ptr + offset + i, 8,
 								1000);
 		if (status != HAL_OK)
+		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
+			hf_i2c_reinit(&hi2c);
+			goto out;
+		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
 		while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
 		i = i + 8;
@@ -97,11 +121,15 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 								I2C_MEMADD_SIZE_8BIT, data_ptr + offset + i, 1,
 								1000);
 		if (status != HAL_OK)
+		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
+			hf_i2c_reinit(&hi2c);
+			goto out;
+		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
 		while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
 	}
-
+out:
 	if (hi2c->Instance == I2C1)
 		HAL_GPIO_WritePin(EEPROM_WP_GPIO_Port, EEPROM_WP_Pin, GPIO_PIN_SET);
 	return status;
@@ -116,6 +144,7 @@ int hf_i2c_reg_write_block(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							   data_ptr, len, 0xff);
 	if (status != HAL_OK) {
 		printf("I2Cx_write_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
+		hf_i2c_reinit(&hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -133,6 +162,7 @@ int hf_i2c_reg_read_block(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							  data_ptr, len, 0xff);
 	if (status != HAL_OK){
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
+		hf_i2c_reinit(&hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
-- 
2.25.1

