From a2452df11488eb92d52ef8217e6de13f7a0740e5 Mon Sep 17 00:00:00 2001
From: xuxiang <xuxiang@eswincomputing.com>
Date: Thu, 23 May 2024 13:28:55 +0800
Subject: [PATCH 057/109] WIN2030-15279:perf:push key send poweroff to mcpu

Changelogs:
1. long press key send poweroff msg to mcpu

Change-Id: Icd95a41b9fe90db1e72337104801bb1754c7da0b
---
 Core/Src/hf_gpio_process.c |  8 +++++++-
 Core/Src/hf_i2c.c          | 18 ++++++++++--------
 2 files changed, 17 insertions(+), 9 deletions(-)

diff --git a/Core/Src/hf_gpio_process.c b/Core/Src/hf_gpio_process.c
index 2a53ed3..5d79a1e 100644
--- a/Core/Src/hf_gpio_process.c
+++ b/Core/Src/hf_gpio_process.c
@@ -60,6 +60,7 @@ static void key_process(void)
 	TickType_t pressStartTime = 0;
 	TickType_t ReleaseTime = 0;
 	TickType_t currentTime = 0;
+	int ret = 0;
 
 	while (key_status == KEY_PUSHDOWN) {
 		currentTime = xTaskGetTickCount();
@@ -114,7 +115,12 @@ static void key_process(void)
 			printf("KEY_LONG_PRESS_STATE time %ld\n", currentTime - pressStartTime);
 			button_state = KEY_PRESS_STATE_END;
 			if (get_som_power_state() == SOM_POWER_ON) {
-				change_som_power_state(SOM_POWER_OFF);
+				ret = web_cmd_handle(CMD_POWER_OFF, NULL, 0, 2000);
+				if (HAL_OK != ret) {
+					change_som_power_state(SOM_POWER_OFF);
+				}
+				// Trigger the Som timer to enusre SOM could poweroff in 5 senconds
+				TriggerSomPowerOffTimer();
 			}
 			break;
 		case KEY_DOUBLE_PRESS_STATE:
diff --git a/Core/Src/hf_i2c.c b/Core/Src/hf_i2c.c
index dd657d6..8efc972 100644
--- a/Core/Src/hf_i2c.c
+++ b/Core/Src/hf_i2c.c
@@ -5,11 +5,13 @@ void hf_i2c_reinit(I2C_HandleTypeDef *hi2c)
 {
 	if (hi2c->Instance == I2C1)
 	{
+		printf("I2C1 reinit\n");
 		i2c_deinit(I2C1);
 		i2c_init(I2C1);
 	}
 	else if (hi2c->Instance == I2C3)
 	{
+		printf("I2C3 reinit\n");
 		i2c_deinit(I2C3);
 		i2c_init(I2C3);
 	}
@@ -24,7 +26,7 @@ int hf_i2c_reg_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							   data_ptr, 0x1, 0xff);
 	if (status != HAL_OK) {
 		printf("I2Cx_write_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
-		hf_i2c_reinit(&hi2c);
+		hf_i2c_reinit(hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -42,7 +44,7 @@ int hf_i2c_reg_read(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							  data_ptr, 0x1, 0xff);
 	if (status != HAL_OK){
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
-		hf_i2c_reinit(&hi2c);
+		hf_i2c_reinit(hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -62,7 +64,7 @@ int hf_i2c_mem_read(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 	if (status != HAL_OK)
 	{
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
-		hf_i2c_reinit(&hi2c);
+		hf_i2c_reinit(hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -90,7 +92,7 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 		if (status != HAL_OK)
 		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
-			hf_i2c_reinit(&hi2c);
+			hf_i2c_reinit(hi2c);
 			goto out;
 		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
@@ -106,7 +108,7 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 		if (status != HAL_OK)
 		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
-			hf_i2c_reinit(&hi2c);
+			hf_i2c_reinit(hi2c);
 			goto out;
 		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
@@ -123,7 +125,7 @@ int hf_i2c_mem_write(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 		if (status != HAL_OK)
 		{
 			printf("I2Cx_write_Error(slave_addr:%x, errcode:%d) %d;\r\n", slave_addr, status, j);
-			hf_i2c_reinit(&hi2c);
+			hf_i2c_reinit(hi2c);
 			goto out;
 		}
 		while (HAL_I2C_IsDeviceReady(hi2c, slave_addr, 0xff, 0xff) == HAL_TIMEOUT);
@@ -144,7 +146,7 @@ int hf_i2c_reg_write_block(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							   data_ptr, len, 0xff);
 	if (status != HAL_OK) {
 		printf("I2Cx_write_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
-		hf_i2c_reinit(&hi2c);
+		hf_i2c_reinit(hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
@@ -162,7 +164,7 @@ int hf_i2c_reg_read_block(I2C_HandleTypeDef *hi2c, uint8_t slave_addr,
 							  data_ptr, len, 0xff);
 	if (status != HAL_OK){
 		printf("I2Cx_read_Error(%x) reg %x; status %x\r\n", slave_addr, reg_addr, status);
-		hf_i2c_reinit(&hi2c);
+		hf_i2c_reinit(hi2c);
 		return status;
 	}
 	while (HAL_I2C_GetState(hi2c) != HAL_I2C_STATE_READY);
-- 
2.25.1

