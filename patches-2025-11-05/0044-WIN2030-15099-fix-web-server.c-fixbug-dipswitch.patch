From 2b3d78b432f81db5cc6c7561d35a165092338bcf Mon Sep 17 00:00:00 2001
From: yuan junhui <yuanjunhui@eswincomputing.com>
Date: Mon, 20 May 2024 19:52:19 +0800
Subject: [PATCH 044/109] WIN2030-15099:fix(web-server.c):fixbug dipswitch

Changelogs:
01,fixbug dipswitch
02,boardSN width180,sn length18
03,mem leak

Change-Id: Icf94c8d15c1f7eb0de8a4d3ff3f3ef1fbd8f8660
---
 Core/Src/web-server.c                         | 25 +++++++++++++------
 .../Third_Party/LwIP/src/include/lwip/opt.h   |  2 +-
 2 files changed, 18 insertions(+), 9 deletions(-)

diff --git a/Core/Src/web-server.c b/Core/Src/web-server.c
index e192d2c..d63369d 100644
--- a/Core/Src/web-server.c
+++ b/Core/Src/web-server.c
@@ -9287,6 +9287,7 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
 																	$('input[name=\"dip04\"][value=\"' + response.data.dip04 + '\"]').prop('checked', true);\n \
 																	$('input[name=\"swctrl\"][value=\"' + response.data.swctrl + '\"]').prop('checked', true);\n \
 																} \n \
+																toggleDipRadios($('input[name=\"swctrl\"]').val() === '1');\n \
                                                                 console.log('dip_switch refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9641,7 +9642,7 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
 											<label>pcbRevision:</label> <input type=\"text\" id=\"som_pcbRevision\" value=\"0\" style=\"width: 100px;\" disabled>  <br> \
 											</div> \
 											<div class=\"network-row\"> \
-											<label>boardSerialNumber:</label> <input type=\"text\" id=\"som_boardSerialNumber\" value=\"0\" style=\"width: 100px;\" disabled>  <br> \
+											<label>boardSerialNumber:</label> <input type=\"text\" id=\"som_boardSerialNumber\" value=\"0\" style=\"width: 180px;\" disabled>  <br> \
 											</div> \
 											<button id=\"board-info-som-refresh\" >refresh</button> \
 											<h4>CarrierBoard Info</h4> \
@@ -9658,7 +9659,7 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
 											<label>pcbRevision:</label> <input type=\"text\" id=\"cb_pcbRevision\" value=\"0\" style=\"width: 100px;\" disabled>  <br> \
 											</div> \
 											<div class=\"network-row\"> \
-											<label>boardSerialNumber:</label> <input type=\"text\" id=\"cb_boardSerialNumber\" value=\"0\" style=\"width: 100px;\" disabled>  <br> \
+											<label>boardSerialNumber:</label> <input type=\"text\" id=\"cb_boardSerialNumber\" value=\"0\" style=\"width: 180px;\" disabled>  <br> \
 											</div> \
 											<button id=\"board-info-cb-refresh\" >refresh</button> \
 										</div> \
@@ -10587,6 +10588,7 @@ int get_soc_status()
                     found_session_user_name=strdup(found_session->session_data);
                 }
             }
+			free(cookies_copy);
         }
 
         char resp_cookies[BUF_SIZE_256] = {0};
@@ -10869,7 +10871,7 @@ int get_soc_status()
 				int rett = get_som_info(pSimpleInfo);
 
 				char json_response[BUF_SIZE_256]={0};
-                char *json_response_patt = "{\"status\":%d,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%s\"}}";
+                char *json_response_patt = "{\"status\":%d,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%.18s\"}}";
                 sprintf(json_response, json_response_patt,rett,pSimpleInfo->magic,pSimpleInfo->version,pSimpleInfo->id,pSimpleInfo->pcb,pSimpleInfo->sn);
 
                 char response_header[BUF_SIZE_256];
@@ -10890,7 +10892,7 @@ int get_soc_status()
 				CBSimpleInfo simpleInfo=get_cb_info();
 
                	char json_response[BUF_SIZE_256]={0};
-                char *json_response_patt = "{\"status\":0,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%s\"}}";
+                char *json_response_patt = "{\"status\":0,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%.18s\"}}";
                 sprintf(json_response, json_response_patt,simpleInfo.magicNumber,simpleInfo.formatVersionNumber,simpleInfo.productIdentifier,simpleInfo.pcbRevision,simpleInfo.boardSerialNumber);
 
                 char response_header[BUF_SIZE_256];
@@ -11089,11 +11091,17 @@ int get_soc_status()
                     // web_debug("param password: %s \n",password);
 
                     bool loginSuccess = validate_credentials(username,password)==0?TRUE:FALSE;
-						char *json_response=NULL;
-						char response_header[BUF_SIZE_256];
+					char *json_response=NULL;
+					char response_header[BUF_SIZE_256];
                     if(loginSuccess){
 						json_response="{\"status\":0,\"message\":\"success!\",\"data\":{}}";
-
+						if(found_session_user_name!=NULL && strlen(found_session_user_name)>0 ){
+							//clean exist login info
+							if(sidValue!=NULL){
+								delete_session(sidValue);
+//								assert(ret>0);//make sure delete ok
+							}
+						}
                         //add sessions
                         char session_id[SESSION_ID_LENGTH + 1];
                         generate_session_id(session_id, SESSION_ID_LENGTH);
@@ -11183,7 +11191,7 @@ int get_soc_status()
                         if(sidValue!=NULL){
                             int ret=delete_session(sidValue);
                             // web_debug("delete sidValue:%s\n",sidValue);
-                            assert(ret>0);//make sure delete ok
+                            // assert(ret>0);//make sure delete ok
                         }
                     }
 					char response_header[BUF_SIZE_256];
@@ -11532,6 +11540,7 @@ int get_soc_status()
             send_response_200(conn);
         }
         free(buf_copy);
+		free(found_session_user_name);
      }else{
         web_debug("ERROR :444444444444444444444444444444 \n");
         web_debug("http_server_netconn_serve after else 33333333333333\n");
diff --git a/Middlewares/Third_Party/LwIP/src/include/lwip/opt.h b/Middlewares/Third_Party/LwIP/src/include/lwip/opt.h
index 1b4e39d..3c9352b 100644
--- a/Middlewares/Third_Party/LwIP/src/include/lwip/opt.h
+++ b/Middlewares/Third_Party/LwIP/src/include/lwip/opt.h
@@ -1290,7 +1290,7 @@
  * an upper limit on the MSS advertised by the remote host.
  */
 #if !defined TCP_MSS || defined __DOXYGEN__
-#define TCP_MSS                         536
+#define TCP_MSS                         640
 #endif
 
 /**
-- 
2.25.1

