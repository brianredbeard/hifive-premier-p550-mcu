From 08b2b838fc75a333dc278d29e594dc1fcf4a4ae8 Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?=E2=80=9Chuangyifeng=E2=80=9D?=
 <huangyifeng@eswincomputing.com>
Date: Fri, 10 May 2024 10:56:19 +0800
Subject: [PATCH 016/109] WIN2030-15099:refactor(bmc):bmc web cmd support

Changelogs:
        1.add mutex to make the uart4 send operation atmoic
        2.web support get som power status
        3.add MX_UART4_Init() to board init temporarily, this should be
          check

Change-Id: Ib6be4d0db60d8397d42f29f9004a17cd9d2aeb1b
---
 Core/Src/hf_board_init.c       |  1 +
 Core/Src/hf_protocol_process.c | 45 +++++++++++++++++++++++++++++++++-
 Core/Src/web-server.c          | 12 ++++-----
 3 files changed, 51 insertions(+), 7 deletions(-)

diff --git a/Core/Src/hf_board_init.c b/Core/Src/hf_board_init.c
index fc07ee9..f61da93 100644
--- a/Core/Src/hf_board_init.c
+++ b/Core/Src/hf_board_init.c
@@ -134,6 +134,7 @@ int board_init(void)
 	MX_DMA_Init();
 	MX_SPI2_Init();
 	MX_USART3_UART_Init();
+	MX_UART4_Init();
 	MX_RTC_Init();
 	MX_TIM4_Init();
 	MX_SPI1_Init();
diff --git a/Core/Src/hf_protocol_process.c b/Core/Src/hf_protocol_process.c
index 31b212b..c105c4c 100644
--- a/Core/Src/hf_protocol_process.c
+++ b/Core/Src/hf_protocol_process.c
@@ -8,6 +8,7 @@
 #include "stm32f4xx_hal.h"
 #include "task.h"
 #include "queue.h"
+#include "semphr.h"
 
 #define head_meg "\xA5\x5A\xAA\x55"
 #define end_msg "\x0D\x0A\x0D\x0A"
@@ -473,6 +474,35 @@ void dump_message(Message data)
 	printf("Header: 0x%lX, Cmd Type: 0x%x, Data Len: %d, Checksum: 0x%X, Tail: 0x%lx\n",
 		data.header, data.cmd_type, data.data_len, data.checksum, data.tail);
 }
+// Define a mutex handle
+SemaphoreHandle_t xMutex = NULL;
+
+// Function to initialize the mutex
+void init_transmit_mutex(void) {
+    // Create the mutex
+    xMutex = xSemaphoreCreateMutex();
+    // Check if the mutex was created successfully
+    if (xMutex == NULL) {
+        // Mutex creation failed
+        // Handle the error here
+    }
+}
+
+// Function to acquire the mutex
+void acquire_transmit_mutex(void) {
+    // Attempt to take the mutex
+    if (xSemaphoreTake(xMutex, portMAX_DELAY) != pdPASS) {
+        // Failed to acquire the mutex
+        // Handle the error here
+    }
+}
+
+// Function to release the mutex
+void release_transmit_mutex(void) {
+    // Release the mutex
+    xSemaphoreGive(xMutex);
+}
+
 // Function to check message checksum
 int check_checksum(Message *msg)
 {
@@ -502,10 +532,17 @@ BaseType_t transmit_deamon_request(Message *msg)
 {
 	UART_HandleTypeDef *huart = &huart4;
 
+	// Acquire the mutex before transmitting
+	acquire_transmit_mutex();
+
 	generate_checksum(msg);
 	// Transmit using DMA
 	HAL_StatusTypeDef status = HAL_UART_Transmit(huart, (uint8_t *)msg,
 			sizeof(Message), HAL_MAX_DELAY);
+
+	// Release the mutex after transmitting
+	release_transmit_mutex();
+
 	if (status == HAL_OK) {
 		return status; // Successful transmission
 	} else {
@@ -513,6 +550,7 @@ BaseType_t transmit_deamon_request(Message *msg)
 		return status; // Transmission failed
 	}
 }
+
 int web_cmd_handle(CommandType cmd, void *data, int data_len, uint32_t timeout)
 {
 	HAL_StatusTypeDef status;
@@ -587,8 +625,11 @@ void deamon_keeplive_task(void *argument)
 	deamon_stats_t old_status;
 	static uint8_t count = 0;
 
-	printf("SOM Daemon status %s!\n", som_daemon_state == SOM_DAEMON_ON ? "on" : "off");
 	for (;;) {
+		if (SOM_POWER_ON != som_power_state) {
+			osDelay(50);
+			continue;
+		}
 		old_status = som_daemon_state;
 		ret = web_cmd_handle(CMD_BOARD_STATUS, NULL, 0, 1000);
 		if (HAL_OK != ret) {
@@ -650,6 +691,8 @@ void uart4_protocol_task(void *argument)
 {
 	Message msg;
 
+	init_transmit_mutex();
+
 	xUart4MsgQueue = xQueueCreate(QUEUE_LENGTH, sizeof(Message));
 	if (xUart4MsgQueue == NULL) {
 		printf("Failed to create msg queue!\n");
diff --git a/Core/Src/web-server.c b/Core/Src/web-server.c
index 3abfc00..3f2ffa5 100644
--- a/Core/Src/web-server.c
+++ b/Core/Src/web-server.c
@@ -10332,12 +10332,10 @@ void unescape_colon(char *str) {
     }
 }
 
-
-
-
-int get_power_status(){
-	printf("TODO call get_power_status \n");
-	return 1;//1:powerON,0:powerOFF
+//1:powerON,0:powerOFF
+int get_power_status()
+{
+	return som_power_state == SOM_POWER_ON ? 1 : 0;
 }
 
 //status 0:power off,1:power on
@@ -10455,6 +10453,8 @@ PVTInfo get_pvt_info()
 {
 	int ret = HAL_OK;
 	PVTInfo pvtInfo = {
+		.cpu_temp = -1,
+		.npu_temp = -1,
 		.fan_speed = -1,
 	};
 
-- 
2.25.1

