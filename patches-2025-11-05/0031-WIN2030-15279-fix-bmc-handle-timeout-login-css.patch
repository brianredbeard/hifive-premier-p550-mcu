From 30737b07aa0c82b75ad83f0a6dd502379cc86413 Mon Sep 17 00:00:00 2001
From: yuan junhui <yuanjunhui@eswincomputing.com>
Date: Tue, 14 May 2024 14:20:30 +0800
Subject: [PATCH 031/109] WIN2030-15279:fix(bmc):handle timeout,login css

Changelogs:
01,handle timeout
02,login,modify account css

Change-Id: I8981cf628319a2e9a7a4d7624b90317bda520dbd
---
 Core/Src/web-server.c | 271 ++++++++++++++++++++++++------------------
 1 file changed, 153 insertions(+), 118 deletions(-)

diff --git a/Core/Src/web-server.c b/Core/Src/web-server.c
index bcbd11c..b52e219 100644
--- a/Core/Src/web-server.c
+++ b/Core/Src/web-server.c
@@ -9442,18 +9442,26 @@ const unsigned char login_html[] ="<html lang=\"zh\"> \
                                         <meta charset=\"UTF-8\"> \
                                         <title>User Login</title> \
 										<link rel=\"icon\" href=\"data:,\"> \
+										<style> \
+										.network-row { \
+											display: flex; \
+											margin-bottom: 10px; \
+											align-items: center; \
+										} \
+										label { \
+											width: 200px; /* 设置label的固定宽度以确保对齐 */ \
+										} \
+										</style> \
                                     </head> \
                                     <body> \
                                         <h2>User Login</h2> \
                                         <form action=\"/login\" method=\"POST\"> \
-                                            <div> \
-                                                <label for=\"username\">Username:</label> \
-                                                <input type=\"text\" id=\"username\" name=\"username\" required> \
-                                            </div> \
-                                            <div> \
-                                                <label for=\"password\">Password:</label> \
-                                                <input type=\"password\" id=\"password\" name=\"password\" required> \
-                                            </div> \
+												<div class=\"network-row\"> \
+													<label for=\"username\">Username:</label> <input type=\"text\" id=\"username\" name=\"username\" required> \
+												</div> \
+												<div class=\"network-row\"> \
+                                                	<label for=\"password\">Password:</label>  <input type=\"password\" id=\"password\" name=\"password\" required> \
+												</div>\
                                             <div> \
                                                 <button type=\"submit\">Login</button> \
                                             </div> \
@@ -9512,10 +9520,12 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                                 byhand: $('#net-work-refresh-hid').val(),\n \
                                                             },\
                                                             success: function(response) {\n \
-                                                                $('#ipaddr').val(response.data.ipaddr);\n \
-                                                                $('#gateway').val(response.data.gateway);\n \
-                                                                $('#subnetwork').val(response.data.subnetwork);\n \
-																$('#macaddr').val(response.data.macaddr);\n \
+																if(response.status===0){ \n \
+																	$('#ipaddr').val(response.data.ipaddr);\n \
+																	$('#gateway').val(response.data.gateway);\n \
+																	$('#subnetwork').val(response.data.subnetwork);\n \
+																	$('#macaddr').val(response.data.macaddr);\n \
+																}\n \
                                                                 console.log('Network settings refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9609,9 +9619,11 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                                 byhand: $('#power-consum-refresh-hid').val(),\n \
                                                             },\
                                                             success: function(response) {\n \
-                                                                $('#power_consum').val(response.data.consumption);\n \
-																$('#power_cur').val(response.data.current);\n \
-																$('#power_vol').val(response.data.voltage);\n \
+																if(response.status===0){\n \
+																	$('#power_consum').val(response.data.consumption);\n \
+																	$('#power_cur').val(response.data.current);\n \
+																	$('#power_vol').val(response.data.voltage);\n \
+																} \n \
                                                                 console.log('power_consum refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9635,9 +9647,11 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             },\
 															contentType: 'application/x-www-form-urlencoded', \n \
                                                             success: function(response) {\n \
-                                                                $('#cpu_temp').val(response.data.cpu_temp);\n \
-																$('#npu_temp').val(response.data.npu_temp);\n \
-																$('#fan_speed').val(response.data.fan_speed);\n \
+																if(response.status===0){\n \
+																	$('#cpu_temp').val(response.data.cpu_temp);\n \
+																	$('#npu_temp').val(response.data.npu_temp);\n \
+																	$('#fan_speed').val(response.data.fan_speed);\n \
+																}\n \
                                                                 console.log('pvt info refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9661,11 +9675,13 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             },\
 															contentType: 'application/x-www-form-urlencoded', \n \
                                                             success: function(response) {\n \
-																$('input[name=\"dip01\"][value=\"' + response.data.dip01 + '\"]').prop('checked', true);\n \
-																$('input[name=\"dip02\"][value=\"' + response.data.dip02 + '\"]').prop('checked', true);\n \
-																$('input[name=\"dip03\"][value=\"' + response.data.dip03 + '\"]').prop('checked', true);\n \
-																$('input[name=\"dip04\"][value=\"' + response.data.dip04 + '\"]').prop('checked', true);\n \
-																$('input[name=\"swctrl\"][value=\"' + response.data.swctrl + '\"]').prop('checked', true);\n \
+																if(response.status===0){\n \
+																	$('input[name=\"dip01\"][value=\"' + response.data.dip01 + '\"]').prop('checked', true);\n \
+																	$('input[name=\"dip02\"][value=\"' + response.data.dip02 + '\"]').prop('checked', true);\n \
+																	$('input[name=\"dip03\"][value=\"' + response.data.dip03 + '\"]').prop('checked', true);\n \
+																	$('input[name=\"dip04\"][value=\"' + response.data.dip04 + '\"]').prop('checked', true);\n \
+																	$('input[name=\"swctrl\"][value=\"' + response.data.swctrl + '\"]').prop('checked', true);\n \
+																} \n \
                                                                 console.log('dip_switch refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9724,16 +9740,17 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             },\
 															contentType: 'application/x-www-form-urlencoded', \n \
 															success: function(response) {\n \
-																// 假设返回的数据是{ buttonText: '新按钮文本' }\n \
-																$('#power-on-change').prop(\"disabled\", false); \n \
-																if(response.data.power_status===\"0\"){\n \
-																	$('#power-status-label').text('Power Status (OFF):');\n \
-																	$('#power-on-change').text('powerON');\n \
-																	$('#power-on-change').val('1');\n \
-																}else{\n \
-																	$('#power-status-label').text('Power Status (ON):');\n \
-																	$('#power-on-change').text('powerOFF');\n \
-																	$('#power-on-change').val('0');\n \
+																if(response.status===0){\n \
+																	$('#power-on-change').prop(\"disabled\", false); \n \
+																	if(response.data.power_status===\"0\"){\n \
+																		$('#power-status-label').text('Power Status (OFF):');\n \
+																		$('#power-on-change').text('powerON');\n \
+																		$('#power-on-change').val('1');\n \
+																	}else{\n \
+																		$('#power-status-label').text('Power Status (ON):');\n \
+																		$('#power-on-change').text('powerOFF');\n \
+																		$('#power-on-change').val('0');\n \
+																	}\n \
 																}\n \
 															},\n \
 															error: function(xhr, status, error) {\n \
@@ -9753,16 +9770,18 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             },\
 															contentType: 'application/x-www-form-urlencoded', \n \
 															success: function(response) {\n \
-																$('#power-lostresume-change').prop(\"disabled\", false); \n \
-																if(response.data.power_lostresume_status===\"0\"){\n \
-																	$('#power-lostresume-label').text('Power Lost Resume(disabled):');\n \
-																	$('#power-lostresume-change').text('enable');\n \
-																	$('#power-lostresume-change').val('1');\n \
-																}else{\n \
-																	$('#power-lostresume-label').text('Power Lost Resume(enabled):');\n \
-																	$('#power-lostresume-change').text('disabled');\n \
-																	$('#power-lostresume-change').val('0');\n \
-																}\n \
+																if(response.status===0){\n \
+																	$('#power-lostresume-change').prop(\"disabled\", false); \n \
+																	if(response.data.power_lostresume_status===\"0\"){\n \
+																		$('#power-lostresume-label').text('Power Lost Resume(disabled):');\n \
+																		$('#power-lostresume-change').text('enable');\n \
+																		$('#power-lostresume-change').val('1');\n \
+																	}else{\n \
+																		$('#power-lostresume-label').text('Power Lost Resume(enabled):');\n \
+																		$('#power-lostresume-change').text('disabled');\n \
+																		$('#power-lostresume-change').val('0');\n \
+																	}\n \
+																} \n \
 															},\n \
 															error: function(xhr, status, error) {\n \
 																console.error('An error occurred:', error);\n \
@@ -9775,12 +9794,17 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             url: '/board_info_som',\n \
                                                             type: 'GET',\n \
                                                             success: function(response) {\n \
-                                                                $('#som_magicNumber').val(response.data.magicNumber);\n \
-                                                                $('#som_formatVersionNumber').val(response.data.formatVersionNumber);\n \
-                                                                $('#som_productIdentifier').val(response.data.productIdentifier);\n \
-																$('#som_pcbRevision').val(response.data.pcbRevision);\n \
-																$('#som_boardSerialNumber').val(response.data.boardSerialNumber);\n \
-                                                                console.log('board-info-som-refresh refreshed successfully.');\n \
+																if(response.status===0){ \n \
+																	$('#som_magicNumber').val(response.data.magicNumber);\n \
+																	$('#som_formatVersionNumber').val(response.data.formatVersionNumber);\n \
+																	$('#som_productIdentifier').val(response.data.productIdentifier);\n \
+																	$('#som_pcbRevision').val(response.data.pcbRevision);\n \
+																	$('#som_boardSerialNumber').val(response.data.boardSerialNumber);\n \
+																	console.log('board-info-som-refresh refreshed if ##### .');\n \
+																}else{ \n \
+																	console.log('board-info-som-refresh refreshed else #####.');\n \
+																} \n \
+																console.log('board-info-som-refresh refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
                                                                 // 请求失败时的回调函数\n \
@@ -9794,11 +9818,13 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                             url: '/board_info_cb',\n \
                                                             type: 'GET',\n \
                                                             success: function(response) {\n \
-                                                                $('#cb_magicNumber').val(response.data.magicNumber);\n \
-                                                                $('#cb_formatVersionNumber').val(response.data.formatVersionNumber);\n \
-                                                                $('#cb_productIdentifier').val(response.data.productIdentifier);\n \
-																$('#cb_pcbRevision').val(response.data.pcbRevision);\n \
-																$('#cb_boardSerialNumber').val(response.data.boardSerialNumber);\n \
+																if(response.status===0){ \n \
+																	$('#cb_magicNumber').val(response.data.magicNumber);\n \
+																	$('#cb_formatVersionNumber').val(response.data.formatVersionNumber);\n \
+																	$('#cb_productIdentifier').val(response.data.productIdentifier);\n \
+																	$('#cb_pcbRevision').val(response.data.pcbRevision);\n \
+																	$('#cb_boardSerialNumber').val(response.data.boardSerialNumber);\n \
+																}\n \
                                                                 console.log('board-info-cb-refresh refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9816,20 +9842,22 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                                 byhand: $('#rtc-refresh-hid').val(),\n \
                                                             },\
                                                             success: function(response) {\n \
-                                                                $('#rtc_year').val(response.data.year);\n \
-                                                                $('#rtc_month').val(response.data.month);\n \
-                                                                $('#rtc_date').val(response.data.date);\n \
-																$('#rtc_weekday').val(response.data.weekday);\n \
-																$('#rtc_hours').val(response.data.hours);\n \
-																$('#rtc_minutes').val(response.data.minutes);\n \
-																$('#rtc_seconds').val(response.data.seconds);\n \
-																var rtc_datetime = response.data.year + '-' + \
-																			response.data.month + '-' +  \
-																			response.data.date + ' ' +  \
-																			response.data.hours + ':' +  \
-																			response.data.minutes + ':' +  \
-																			response.data.seconds; \
-																$('#rtc_datetime').val(rtc_datetime); \
+																if(response.status===0){ \n \
+																	$('#rtc_year').val(response.data.year);\n \
+																	$('#rtc_month').val(response.data.month);\n \
+																	$('#rtc_date').val(response.data.date);\n \
+																	$('#rtc_weekday').val(response.data.weekday);\n \
+																	$('#rtc_hours').val(response.data.hours);\n \
+																	$('#rtc_minutes').val(response.data.minutes);\n \
+																	$('#rtc_seconds').val(response.data.seconds);\n \
+																	var rtc_datetime = response.data.year + '-' + \
+																				response.data.month + '-' +  \
+																				response.data.date + ' ' +  \
+																				response.data.hours + ':' +  \
+																				response.data.minutes + ':' +  \
+																				response.data.seconds; \
+																	$('#rtc_datetime').val(rtc_datetime); \
+																}\n \
                                                                 console.log('rtc refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -9889,11 +9917,13 @@ const unsigned char info_html[] ="<html lang=\"en\"> \
                                                                 byhand: $('#soc-refresh-hid').val(),\n \
                                                             },\
                                                             success: function(response) {\n \
-																if(response.data.status===\"0\"){ \n \
-																	$('#soc-status').val(\"working\");\n \
-																}else{\n \
-																	$('#soc-status').val(\"stopped\");\n \
-																} \n \
+																if(response.status===0){ \n \
+																	if(response.data.status===\"0\"){ \n \
+																		$('#soc-status').val(\"working\");\n \
+																	}else{\n \
+																		$('#soc-status').val(\"stopped\");\n \
+																	} \n \
+																}\n \
                                                                 console.log('rtc refreshed successfully.');\n \
                                                             },\n \
                                                             error: function(xhr, status, error) {\n \
@@ -10140,6 +10170,14 @@ const unsigned char modify_account_html[] ="<html lang=\"zh\"> \
                                                 top: 10px; \
                                                 right: 50px; \
                                             } \
+											.network-row { \
+												display: flex; \
+												margin-bottom: 10px; \
+												align-items: center; \
+											} \
+											label { \
+												width: 200px; /* 设置label的固定宽度以确保对齐 */ \
+											} \
                                             </style> \
                                     </head> \
                                     <body> \
@@ -10153,14 +10191,12 @@ const unsigned char modify_account_html[] ="<html lang=\"zh\"> \
                                         </div> \
                                         <h2>Account modify</h2> \
                                         <form action=\"/modify_account\" method=\"POST\"> \
-                                            <div> \
-                                                <label for=\"username\">Username:</label> \
-                                                <input type=\"text\" id=\"username\" name=\"username\" value=\"%s\" required disabled> \
-                                            </div> \
-                                            <div> \
-                                                <label for=\"password\">Password:</label> \
-                                                <input type=\"password\" id=\"password\" name=\"password\" required> \
-                                            </div> \
+											<div class=\"network-row\"> \
+												<label for=\"username\">Username:</label> <input type=\"text\" id=\"username\" name=\"username\" value=\"%s\" required disabled> \
+											</div> \
+											<div class=\"network-row\"> \
+												<label for=\"password\">Password:</label>  <input type=\"password\" id=\"password\" name=\"password\" required> \
+											</div> \
                                             <div> \
                                                 <button type=\"submit\">Update</button> \
                                             </div> \
@@ -10595,7 +10631,7 @@ static int change_power_status(int status)
 			if (HAL_OK != ret) {
 				change_som_power_state(SOM_POWER_OFF);
 				printf("Poweroff SOM error(ret %d), force shutdown it!\n", ret);
-				ret = HAL_OK;
+				// ret = HAL_OK;
 				return ret;
 			}
 			// Trigger the Som timer to enusre SOM could poweroff in 5 senconds
@@ -10744,22 +10780,16 @@ typedef struct {
 	int fan_speed;
 } PVTInfo;
 
-PVTInfo get_pvt_info()
+int get_pvt_info(PVTInfo *ppvtInfo)
 {
 	int ret = HAL_OK;
-	PVTInfo pvtInfo = {
-		.cpu_temp = -1,
-		.npu_temp = -1,
-		.fan_speed = -1,
-	};
-
-	ret = web_cmd_handle(CMD_PVT_INFO, &pvtInfo, sizeof(pvtInfo), 1000);
+	ret = web_cmd_handle(CMD_PVT_INFO, ppvtInfo, sizeof(PVTInfo), 1000);
 	if (HAL_OK != ret) {
 		printf("Faild to get PVT info %d\n", ret);
 	}
 	printf("web call get_pvt_info, cpu_temp %d, npu_temp %d, fan_speed %d, ret %d\n",
-		pvtInfo.cpu_temp, pvtInfo.npu_temp, pvtInfo.fan_speed, ret);
-	return pvtInfo;
+		ppvtInfo->cpu_temp, ppvtInfo->npu_temp,ppvtInfo->fan_speed, ret);
+	return ret;
 }
 
 typedef struct {
@@ -10803,32 +10833,20 @@ typedef struct {
 	uint32_t crc;
 } __attribute__((packed)) som_info;
 
-som_info get_som_info()
+int get_som_info(som_info *psomInfo)
 {
 	int ret = HAL_OK;
-
-	som_info example= {
-		.magic = -1,
-		.version = -1,
-		.id = -1,
-		.pcb = -1,
-		.bom_revision = -1,
-		.bom_variant = -1,
-		.sn = "v1.10.1",
-		.status = -1,
-	};
-	ret = web_cmd_handle(CMD_READ_BOARD_INFO, &example, sizeof(example), 1000);
+	ret = web_cmd_handle(CMD_READ_BOARD_INFO, psomInfo, sizeof(som_info), 1000);
 	if (HAL_OK != ret) {
 		printf("Faild to get som info %d\n", ret);
 	}
 	printf("web call get_som_info, magic %d, version %d, "
 		"id %d, pcb %d, bom_revision %d, bom_variant %d, "
 		"sn %s, status %d, ret %d\n",
-		example.magic, example.version ,
-		example.id, example.pcb , example.bom_revision, example.bom_variant,
-		example.sn, example.status, ret);
-
-	return example;
+		psomInfo->magic, psomInfo->version ,
+		psomInfo->id, psomInfo->pcb , psomInfo->bom_revision, psomInfo->bom_variant,
+		psomInfo->sn, psomInfo->status, ret);
+	return ret;
 }
 
 typedef struct {
@@ -11140,12 +11158,20 @@ int get_soc_status()
 
 			}else if(strcmp(path, "/pvt_info")==0 ){
 				printf("GET location: pvt_info \n");
-				PVTInfo pvt_info=get_pvt_info();
+				
+
+				PVTInfo pvtInfo = {
+					.cpu_temp = -1,
+					.npu_temp = -1,
+					.fan_speed = -1,
+				};
+				PVTInfo *ppvt_info=&pvtInfo;
+				int rett=get_pvt_info(ppvt_info);
 
 				char json_response[BUF_SIZE_128]={0};
 				 // 创建JSON格式的字符串
-                char *json_response_patt = "{\"status\":0,\"message\":\"success\",\"data\":{\"cpu_temp\":\"%d\",\"npu_temp\":\"%d\",\"fan_speed\":\"%d\"}}";
-                sprintf(json_response, json_response_patt,pvt_info.cpu_temp,pvt_info.npu_temp,pvt_info.fan_speed);
+                char *json_response_patt = "{\"status\":%d,\"message\":\"success\",\"data\":{\"cpu_temp\":\"%d\",\"npu_temp\":\"%d\",\"fan_speed\":\"%d\"}}";
+                sprintf(json_response, json_response_patt,rett,ppvt_info->cpu_temp,ppvt_info->npu_temp,ppvt_info->fan_speed);
 
 
                 char response_header[BUF_SIZE_256];
@@ -11257,14 +11283,23 @@ int get_soc_status()
 
             }else if(strcmp(path, "/board_info_som")==0 ){
                 printf("get ,location: /board_info_som \n");
-				som_info simpleInfo= get_som_info();
+				som_info example= {
+					.magic = -1,
+					.version = -1,
+					.id = -1,
+					.pcb = -1,
+					.bom_revision = -1,
+					.bom_variant = -1,
+					.sn = "v1.10.1",
+					.status = -1,
+				};
+				som_info *pSimpleInfo=&example;
+				int rett = get_som_info(pSimpleInfo);
 
 				char json_response[BUF_SIZE_256]={0};
 				 // 创建JSON格式的字符串
-                char *json_response_patt = "{\"status\":0,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%s\"}}";
-                sprintf(json_response, json_response_patt,simpleInfo.magic,simpleInfo.version,simpleInfo.id,simpleInfo.pcb,simpleInfo.sn);
-
-
+                char *json_response_patt = "{\"status\":%d,\"message\":\"success\",\"data\":{\"magicNumber\":\"%d\",\"formatVersionNumber\":\"%d\",\"productIdentifier\":\"%d\",\"pcbRevision\":\"%d\",\"boardSerialNumber\":\"%s\"}}";
+                sprintf(json_response, json_response_patt,rett,pSimpleInfo->magic,pSimpleInfo->version,pSimpleInfo->id,pSimpleInfo->pcb,pSimpleInfo->sn);
 
                 char response_header[BUF_SIZE_256];
                 if(found_session_user_name!=NULL && strlen(found_session_user_name)>0 && byhand ){
-- 
2.25.1

