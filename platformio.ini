[platformio]
# Set debug-ftdi as the recommended default environment
default_envs = debug-ftdi

# Support local configuration overrides (monitor_port, etc.)
extra_configs = platformio_override.ini

[env:genericSTM32F407VET6]
platform = ststm32
board = genericSTM32F407VET6
framework = stm32cube

; Build configuration
build_flags =
        -D USE_HAL_DRIVER
    -D STM32F407xx
    -D HSE_VALUE=25000000U
    ; Network configuration - 192.168.137.42/24
    -D IP_ADDR0=192U
    -D IP_ADDR1=168U
    -D IP_ADDR2=137U
    -D IP_ADDR3=42U
    -D NETMASK_ADDR0=255U
    -D NETMASK_ADDR1=255U
    -D NETMASK_ADDR2=255U
    -D NETMASK_ADDR3=0U
    -D GATEWAY_ADDR0=192U
    -D GATEWAY_ADDR1=168U
    -D GATEWAY_ADDR2=137U
    -D GATEWAY_ADDR3=1U
    ; MAC_ADDR0-5 defined in include/stm32f4xx_hal_conf.h with #ifndef guards
    -I include
    -Wl,-lc -Wl,-lm -Wl,-lnosys
    -mthumb
    -mcpu=cortex-m4
    -mfpu=fpv4-sp-d16
    -mfloat-abi=hard
    -mfloat-abi=hard
    -mfpu=fpv4-sp-d16
    -Wl,--no-warn-mismatch
    -D USE_FREERTOS
    -D configUSE_CMSIS_RTOS_V2=1

; Source file configuration
build_src_filter =
        +<*>                           ; Include everything in src/

; Libraries
lib_deps =
        mincrmatt12/STM32Cube Middleware-FreeRTOS
        mincrmatt12/STM32Cube Middleware-LwIP

; FreeRTOS configuration
custom_freertos_config_location = include/FreeRTOSConfig.h
custom_freertos_cmsis_impl = CMSIS_RTOS_V2
custom_freertos_features = timers, event_groups

; LwIP configuration
custom_lwip_opts_location = include/lwipopts.h

; HAL configuration
custom_hal_conf_location = include/stm32f4xx_hal_conf.h

; Upload configuration
upload_protocol = stlink
debug_tool = stlink

; Monitor configuration
monitor_speed = 115200

; Debug configuration
debug_init_break = tbreak main

# ============================================================
# Debugging Configurations
# See docs/debugging/quick-start.md for setup instructions
# ============================================================

[env:debug-ftdi]
# Recommended: Uses onboard FT4232H (Interface 1 for JTAG)
# Requires: platformio_override.ini with monitor_port configured
platform = ststm32
board = p550_ft4232h
framework = stm32cube

# Inherit common build flags and settings from base environment
build_flags = ${env:genericSTM32F407VET6.build_flags}
build_src_filter = ${env:genericSTM32F407VET6.build_src_filter}
lib_deps = ${env:genericSTM32F407VET6.lib_deps}

# FreeRTOS configuration
custom_freertos_config_location = include/FreeRTOSConfig.h
custom_freertos_cmsis_impl = CMSIS_RTOS_V2
custom_freertos_features = timers, event_groups

# LwIP configuration
custom_lwip_opts_location = include/lwipopts.h

# HAL configuration
custom_hal_conf_location = include/stm32f4xx_hal_conf.h

# Debug configuration using OpenOCD
debug_tool = custom
debug_server =
    $PLATFORMIO_CORE_DIR/packages/tool-openocd/bin/openocd
    -s
    $PLATFORMIO_CORE_DIR/packages/tool-openocd/openocd/scripts
    -f
    $PROJECT_DIR/boards/ft4232h-mcu-jtag.cfg
debug_port = localhost:3333
debug_init_break = tbreak main

# Serial monitor configuration
# NOTE: monitor_port MUST be set in platformio_override.ini
#       See platformio_override.ini.example for platform-specific examples
monitor_speed = 115200

# Upload configuration (uses Python script for reliable path resolution)
upload_protocol = custom
extra_scripts = post:upload_ftdi.py

[env:debug-stlink]
# Legacy: External ST-Link/V2 debugger
# Maintained for backwards compatibility
platform = ststm32
board = genericSTM32F407VET6
framework = stm32cube
build_flags = ${env:genericSTM32F407VET6.build_flags}
build_src_filter = ${env:genericSTM32F407VET6.build_src_filter}
lib_deps = ${env:genericSTM32F407VET6.lib_deps}

# FreeRTOS configuration
custom_freertos_config_location = include/FreeRTOSConfig.h
custom_freertos_cmsis_impl = CMSIS_RTOS_V2
custom_freertos_features = timers, event_groups

# LwIP configuration
custom_lwip_opts_location = include/lwipopts.h

# HAL configuration
custom_hal_conf_location = include/stm32f4xx_hal_conf.h

debug_tool = stlink
upload_protocol = stlink
monitor_speed = 115200
debug_init_break = tbreak main

[env:debug-jlink]
# Advanced: J-Link via JTAG header (J18)
# Requires JTAG header connection
platform = ststm32
board = genericSTM32F407VET6
framework = stm32cube
build_flags = ${env:genericSTM32F407VET6.build_flags}
build_src_filter = ${env:genericSTM32F407VET6.build_src_filter}
lib_deps = ${env:genericSTM32F407VET6.lib_deps}

# FreeRTOS configuration
custom_freertos_config_location = include/FreeRTOSConfig.h
custom_freertos_cmsis_impl = CMSIS_RTOS_V2
custom_freertos_features = timers, event_groups

# LwIP configuration
custom_lwip_opts_location = include/lwipopts.h

# HAL configuration
custom_hal_conf_location = include/stm32f4xx_hal_conf.h

debug_tool = jlink
upload_protocol = jlink
monitor_speed = 115200
debug_init_break = tbreak main

# ============================================================
# Testing Environments
# ============================================================

[env:test_native]
# Fast unit tests on host machine (seconds feedback)
platform = native
test_framework = unity
test_build_src = yes
build_flags =
    -D UNIT_TEST
    -std=c11
    -I test/native/common
    -I src
    -I src/web
    -I include
build_src_filter =
    -<*>
    +<web/>
lib_deps =
    throwtheswitch/Unity@^2.5.2
test_ignore =
    test/embedded/*
    lib/test_common

[env:renode-sim]
# Renode simulation environment
platform = ststm32
board = genericSTM32F407VET6
framework = stm32cube

# Inherit build configuration from hardware environment
build_flags =
    ${env:genericSTM32F407VET6.build_flags}
    -DRENODE_SIM  ; Bypass EEPROM reads, use hardcoded board data
build_src_filter = ${env:genericSTM32F407VET6.build_src_filter}
lib_deps = ${env:genericSTM32F407VET6.lib_deps}

# FreeRTOS configuration (CRITICAL - must match hardware environment)
custom_freertos_config_location = include/FreeRTOSConfig.h
custom_freertos_cmsis_impl = CMSIS_RTOS_V2
custom_freertos_features = timers, event_groups

# LwIP configuration
custom_lwip_opts_location = include/lwipopts.h

# HAL configuration
custom_hal_conf_location = include/stm32f4xx_hal_conf.h

# Don't upload to hardware
upload_protocol = null

# Post-build script to copy ELF for Renode
extra_scripts = post:scripts/renode_build.py
